<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Grafana/InfluxDB/Telegraf (GKE)</title>
    <url>/2025/03/10/Grafana-InfluxDB-Telegraf-GKE/</url>
    <content><![CDATA[<h2 id="建置StorageClass"><a href="#建置StorageClass" class="headerlink" title="建置StorageClass"></a>建置StorageClass</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li>StorageClass</li>
</ul>
<h3 id="建立-sc-yaml"><a href="#建立-sc-yaml" class="headerlink" title="建立 sc.yaml"></a>建立 <code>sc.yaml</code></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: lily2</span><br><span class="line">provisioner: kubernetes.io/gce-pd</span><br><span class="line">parameters:</span><br><span class="line">  type: pd-standard</span><br><span class="line">reclaimPolicy: Delete #回收策略</span><br><span class="line">allowVolumeExpansion: true #可擴展</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line">#改為等到pod創建才綁定PV，預設是Immediate立即綁頂</span><br></pre></td></tr></table></figure>

<p>apply</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f sc.yaml</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="建置Grafana"><a href="#建置Grafana" class="headerlink" title="建置Grafana"></a>建置Grafana</h2><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><ul>
<li>Grafana本人 - Deployment、Service </li>
<li>數據儲存 - PVC</li>
</ul>
<h3 id="建立-grafana-yaml"><a href="#建立-grafana-yaml" class="headerlink" title="建立 grafana.yaml"></a>建立 <code>grafana.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">lily2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">cloud.google.com/gke-nodepool:</span> <span class="string">lily-pool</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/grafana-enterprise:9.0.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">lily</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">lily</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-pvc</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">	  <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-pvc</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">grafana-pvc</span></span><br><span class="line">        <span class="comment"># resources:</span></span><br><span class="line">        <span class="comment">#   limits:</span></span><br><span class="line">        <span class="comment">#     memory: 200Mi</span></span><br><span class="line">        <span class="comment">#     cpu: 200m</span></span><br><span class="line">        <span class="comment">#   requests:</span></span><br><span class="line">        <span class="comment">#     cpu: 100m</span></span><br><span class="line">        <span class="comment">#     memory: 100Mi</span></span><br><span class="line">      <span class="comment">#pvc有權限問題，需加這段調整權限</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">lily2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">lily2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>

<p>apply</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt; kubectl apply -f grafana.yaml</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="建置InfluxDB"><a href="#建置InfluxDB" class="headerlink" title="建置InfluxDB"></a>建置InfluxDB</h2><h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><ul>
<li>influxdb-config - ConfigMap </li>
<li>存帳密資訊 - Secret</li>
<li>InfluxDB本人 - StatefulSet、Service </li>
<li>儲存數據 - PVC</li>
</ul>
<h3 id="建立-influxdb-config-yaml"><a href="#建立-influxdb-config-yaml" class="headerlink" title="建立 influxdb-config.yaml"></a>建立 <code>influxdb-config.yaml</code></h3><ul>
<li>內容參考此篇 <a href="https://hackmd.io/BNxmcbB3SM2PIL5MEXSpyg">[influxdb-config.yaml]</a></li>
</ul>
<h3 id="建立-influxdb-yaml"><a href="#建立-influxdb-yaml" class="headerlink" title="建立 influxdb.yaml"></a>建立 <code>influxdb.yaml</code></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: influxdb-secret</span><br><span class="line">  namespace: lily2</span><br><span class="line">type: Opaque</span><br><span class="line">stringData: </span><br><span class="line">  INFLUXDB_CONFIG_PATH: /etc/influxdb/influxdb.conf</span><br><span class="line">  INFLUXDB_DATABASE: test</span><br><span class="line">  INFLUXDB_USERNAME: admin2</span><br><span class="line">  INFLUXDB_PASSWORD: 123456</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: influxdb</span><br><span class="line">  namespace: lily2</span><br><span class="line">  labels:</span><br><span class="line">    app: influxdb</span><br><span class="line">spec:</span><br><span class="line">  serviceName: influxdb</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: influxdb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: influxdb</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:</span><br><span class="line">        cloud.google.com/gke-nodepool: lily-pool</span><br><span class="line">      containers:</span><br><span class="line">      - name: influxdb</span><br><span class="line">        image: influxdb:1.8.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: influxdb</span><br><span class="line">          containerPort: 8086</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: influxdb-data</span><br><span class="line">          mountPath: /var/lib/influxdb</span><br><span class="line">        - name: influxdb-config</span><br><span class="line">          mountPath: /etc/influxdb/influxdb.conf</span><br><span class="line">          subPath: influxdb.conf</span><br><span class="line">          readOnly: true</span><br><span class="line">        envFrom:</span><br><span class="line">        - secretRef:</span><br><span class="line">            name: influxdb-secret</span><br><span class="line">      volumes:</span><br><span class="line">      - name: influxdb-data</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: influxdb-pvc</span><br><span class="line">      - name: influxdb-config</span><br><span class="line">        configMap:</span><br><span class="line">         name: influxdb-config</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: influxdb</span><br><span class="line">  namespace: lily2</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8086</span><br><span class="line">      targetPort: 8086</span><br><span class="line">      name: influxdb</span><br><span class="line">  selector:</span><br><span class="line">    app: influxdb</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: influxdb-pvc</span><br><span class="line">  namespace: lily2</span><br><span class="line">  labels:</span><br><span class="line">    app: influxdb</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 300Mi</span><br></pre></td></tr></table></figure>

<p>apply</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt; kubectl apply -f .</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="建置Telegraf"><a href="#建置Telegraf" class="headerlink" title="建置Telegraf"></a>建置Telegraf</h2><h3 id="配置-3"><a href="#配置-3" class="headerlink" title="配置:"></a>配置:</h3><ul>
<li>telegraf-config - ConfigMap </li>
<li>rbac - ClusterRole、ClusterRoleBinding、ServiceAccount</li>
<li>telegraf - DaemonSet</li>
</ul>
<h3 id="建立-telegraf-config-yaml"><a href="#建立-telegraf-config-yaml" class="headerlink" title="建立 telegraf-config.yaml"></a>建立 <code>telegraf-config.yaml</code></h3><ul>
<li>內容參考此篇 <a href="https://hackmd.io/BNxmcbB3SM2PIL5MEXSpyg?view#telegrafconf">[telegraf-config.yaml]</a></li>
</ul>
<p>:::info<br>注意 telegraf.config 要加這段 [[inputs.kube_inventory]]<br>token 是從 ServiceAccount 創建的Secret取得</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[[inputs.kube_inventory]]</span><br><span class="line">  # URL for the kubernetes API</span><br><span class="line">  url = &quot;https://172.16.0.2&quot;</span><br><span class="line">  namespace = &quot;&quot;  </span><br><span class="line">  # namespace空著表示採集所有namespace</span><br><span class="line">  # bearer_token = &quot;/usr/local/telegraf/etc/telegraf/token.csv&quot; # 讀取存放token的檔案，或是用下列方法直接使用token</span><br><span class="line">  bearer_token_string = &quot;eyJhbGciOiJSUzI1NiIsImtp......&quot;</span><br><span class="line">  response_timeout = &quot;5s&quot;</span><br><span class="line">  insecure_skip_verify = true</span><br></pre></td></tr></table></figure>
<p>:::</p>
<h3 id="建立-telegraf-yaml"><a href="#建立-telegraf-yaml" class="headerlink" title="建立 telegraf.yaml"></a>建立 <code>telegraf.yaml</code></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: telegraf</span><br><span class="line">  namespace: lily2</span><br><span class="line">  labels:</span><br><span class="line">    app: telegraf</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: telegraf</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: telegraf</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:</span><br><span class="line">        cloud.google.com/gke-nodepool: lily-pool</span><br><span class="line">      serviceAccountName: &quot;telegraf&quot;</span><br><span class="line">      containers:</span><br><span class="line">      - name: telegraf</span><br><span class="line">        image: telegraf:1.25.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 200Mi</span><br><span class="line">            cpu: 200m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: telegraf-config</span><br><span class="line">          mountPath: /etc/telegraf/telegraf.conf</span><br><span class="line">          readOnly: true</span><br><span class="line">          subPath: telegraf.conf</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: telegraf-config</span><br><span class="line">        configMap:</span><br><span class="line">          name: telegraf-config</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: influx:cluster:viewer</span><br><span class="line">  namespace: lily2</span><br><span class="line">  labels:</span><br><span class="line">    rbac.authorization.k8s.io/aggregate-view-telegraf: &quot;true&quot;</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;persistentvolumes&quot;, &quot;nodes&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: influx:telegraf</span><br><span class="line">  namespace: lily2</span><br><span class="line">aggregationRule:</span><br><span class="line">  clusterRoleSelectors:</span><br><span class="line">    - matchLabels:</span><br><span class="line">        rbac.authorization.k8s.io/aggregate-view-telegraf: &quot;true&quot;</span><br><span class="line">    - matchLabels:</span><br><span class="line">        rbac.authorization.k8s.io/aggregate-to-view: &quot;true&quot;</span><br><span class="line">rules: []</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: influx:telegraf:viewer</span><br><span class="line">  namespace: lily2</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: influx:telegraf</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: telegraf</span><br><span class="line">    namespace: lily2</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: telegraf</span><br><span class="line">  namespace: lily2</span><br></pre></td></tr></table></figure>

<p>apply</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="補充"><a href="#補充" class="headerlink" title="補充"></a>補充</h2><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p>k8s建立grafana<br><a href="https://octoperf.com/blog/2019/09/19/kraken-kubernetes-influxdb-grafana-telegraf/#check-the-influxdb-deployment">https://octoperf.com/blog/2019/09/19/kraken-kubernetes-influxdb-grafana-telegraf/#check-the-influxdb-deployment</a><br>telegraf資料<br><a href="https://www.ywdevops.cn/index.php/2022/06/10/telegraf-5/">https://www.ywdevops.cn/index.php/2022/06/10/telegraf-5/</a><br><a href="https://godleon.github.io/blog/Kubernetes/k8s-How-to-access-resource-legally/">https://godleon.github.io/blog/Kubernetes/k8s-How-to-access-resource-legally/</a></p>
<hr>
<h3 id="influxdb操作"><a href="#influxdb操作" class="headerlink" title="influxdb操作"></a>influxdb操作</h3><p>influxdb驗證<br><a href="https://docs.influxdata.com/influxdb/v1.7/administration/authentication_and_authorization/">https://docs.influxdata.com/influxdb/v1.7/administration/authentication_and_authorization/</a></p>
<p>INFLUXDB 身分驗證<br>|&gt; influx<br>|&gt; auth<br>創建管理員用戶<br>|&gt; create user &lt;*admin*&gt; with password ‘&lt;*password*&gt;’ with all privileges<br>創建非管理員用戶<br>|&gt; create user &lt;*username*&gt; with password ‘&lt;*password*&gt;’</p>
<hr>
<h3 id="InitContainer"><a href="#InitContainer" class="headerlink" title="InitContainer"></a>InitContainer</h3><p>Grafana v9 使用pvc會有權限問題<br>錯誤訊息:<br>(1)GF_PATHS_DATA&#x3D;’&#x2F;var&#x2F;lib&#x2F;grafana’ is not writable.<br>(2)mkdir: can’t create directory ‘&#x2F;var&#x2F;lib&#x2F;grafana&#x2F;plugins’: Permission denied<br>原因: grafana預設讀取權限 grafana:root, 但掛載的方式會將檔案權限更改為 root:root, 因此須將掛載的權限改為grafana所需<br>結論: <del>使用initContainer可解決，參考: <a href="https://cloud.tencent.com/developer/article/1856854">https://cloud.tencent.com/developer/article/1856854</a></del><br>加入這段可解決</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#調整權限</span><br><span class="line">securityContext:</span><br><span class="line">  runAsUser: 0</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技術文件</category>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>gke</tag>
        <tag>monitor</tag>
      </tags>
  </entry>
  <entry>
    <title>Cloud Build</title>
    <url>/2025/03/11/Cloud-Build/</url>
    <content><![CDATA[<h3 id="CI-CD-Workflow"><a href="#CI-CD-Workflow" class="headerlink" title="CI&#x2F;CD Workflow"></a>CI&#x2F;CD Workflow</h3><p>CI 持續整合<br>(1)專案程式碼提交 (commit → push &#x2F; merge)<br>(2)Build、單元測試、整合測試、程式碼規範檢查<br>CD 持續交付<br>(3)完成程式碼部署、營運、監控</p>
<span id="more"></span>
<p><img src="/../images/Cloud-Build/01.png" alt="01"></p>
<hr>
<h3 id="優點"><a href="#優點" class="headerlink" title="優點"></a>優點</h3><p>避免版本衝突<br>降低人為操作失誤<br>減少人工時間花費<br>及早發現(bug)及早修正(fix)<br>專注開發提高生產力<br>加速產品迭代</p>
<hr>
<h2 id="GCP-CI-CD"><a href="#GCP-CI-CD" class="headerlink" title="GCP CI&#x2F;CD"></a>GCP CI&#x2F;CD</h2><p><img src="/../images/Cloud-Build/02.png" alt="02"></p>
<h3 id="Cloud-Build"><a href="#Cloud-Build" class="headerlink" title="Cloud Build"></a>Cloud Build</h3><p> 是一項在 Google Cloud 基礎架構上執行建置的服務。<br> 可從 Cloud Storage、Cloud Source Repositories、GitLab、GitHub 或 Bitbucket 匯入原始程式碼。<br>根據您的規範執行構建，並產生 Docker 容器或 Java 存檔等工件。</p>
<h3 id="Artifact-Registry"><a href="#Artifact-Registry" class="headerlink" title="Artifact Registry"></a>Artifact Registry</h3><p>用於管理私有套件和 Docker 容器映像的存放區</p>
<h3 id="Container-Registry-容器註冊表"><a href="#Container-Registry-容器註冊表" class="headerlink" title="Container Registry 容器註冊表"></a>Container Registry 容器註冊表</h3><p>2024&#x2F;5&#x2F;15後，已棄用，新專案無法再推送<br>2025&#x2F;3&#x2F;18後，將關閉</p>
<h3 id="Cloud-Deploy"><a href="#Cloud-Deploy" class="headerlink" title="Cloud Deploy"></a>Cloud Deploy</h3><p>可依照定義的升級順序自動將應用程式交付到一系列目標環境。<br>達到持續交付。</p>
<h3 id="Source-Repositories"><a href="#Source-Repositories" class="headerlink" title="Source Repositories"></a>Source Repositories</h3><p>託管在 Google Cloud 的 Git儲存庫</p>
<hr>
<h2 id="Cloud-Build-1"><a href="#Cloud-Build-1" class="headerlink" title="Cloud Build"></a>Cloud Build</h2><h3 id="實作-1"><a href="#實作-1" class="headerlink" title="實作-1"></a>實作-1</h3><p>這邊會使用 Cloud Build 構建 Docker image 並將 image 推送到 GAR。</p>
<h4 id="首先新增以下兩個檔案"><a href="#首先新增以下兩個檔案" class="headerlink" title="首先新增以下兩個檔案"></a>首先新增以下兩個檔案</h4><p>1.quickstart.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">echo &quot;Hello, world! The time is $(date).&quot;</span><br></pre></td></tr></table></figure>

<p>2.Dockerfile</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">alpine</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">quickstart.sh</span> <span class="string">/</span></span><br><span class="line"><span class="string">CMD</span> [<span class="string">&quot;/quickstart.sh&quot;</span>]</span><br></pre></td></tr></table></figure>
<p><img src="/../images/Cloud-Build/03.png" alt="03"></p>
<h4 id="在-GCP-Artifact-Registry-建立存放區"><a href="#在-GCP-Artifact-Registry-建立存放區" class="headerlink" title="在 GCP Artifact Registry 建立存放區"></a>在 GCP Artifact Registry 建立存放區</h4><p><img src="/../images/Cloud-Build/04.png" alt="04"></p>
<h4 id="執行CloudBuild"><a href="#執行CloudBuild" class="headerlink" title="執行CloudBuild"></a>執行CloudBuild</h4><p>有兩種方式1.直接透過指令執行、2.透過cloudbuild.yaml檔案執行<br>這邊使用第2種，所以需建立cloudbuild.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/docker&#x27;</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    docker build -t asia-east1-docker.pkg.dev/lab-0808/lily/quickstart-image:tag1 .</span></span><br><span class="line"><span class="string"></span>  <span class="attr">automapSubstitutions:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">images:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&#x27;asia-east1-docker.pkg.dev/lab-0808/lily/quickstart-image:tag1&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="開始創建-docker-image"><a href="#開始創建-docker-image" class="headerlink" title="開始創建 docker image"></a>開始創建 docker image</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcloud builds submit --region=asia-east1 --config cloudbuild.yaml</span><br></pre></td></tr></table></figure>

<h4 id="成功訊息"><a href="#成功訊息" class="headerlink" title="成功訊息"></a>成功訊息</h4><p><img src="/../images/Cloud-Build/05.png" alt="05"></p>
<p><img src="/../images/Cloud-Build/06.png" alt="06"></p>
<hr>
<h3 id="實作-2"><a href="#實作-2" class="headerlink" title="實作-2"></a>實作-2</h3><p>使用觸發條件連結 github 自動 CI</p>
<h4 id="環境準備"><a href="#環境準備" class="headerlink" title="環境準備"></a>環境準備</h4><p>github建立新的repo，git clone到本地端，放入自己的專案<br>並建立Dockerfile、cloudbuild.yaml 兩份檔案</p>
<p>Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /usr/share/nginx/html</span></span><br></pre></td></tr></table></figure>
<p>cloudbuild.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/docker&#x27;</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    docker build -t asia-east1-docker.pkg.dev/peaceful-branch-395402/test1/lilybuild:tag1 .</span></span><br><span class="line"><span class="string"></span>  <span class="attr">automapSubstitutions:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">images:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&#x27;asia-east1-docker.pkg.dev/peaceful-branch-395402/test1/lilybuild:tag1&#x27;</span></span><br></pre></td></tr></table></figure>



<h4 id="CloudBuild-設定觸發條件、連結存放區"><a href="#CloudBuild-設定觸發條件、連結存放區" class="headerlink" title="CloudBuild 設定觸發條件、連結存放區"></a>CloudBuild 設定觸發條件、連結存放區</h4><p><img src="/../images/Cloud-Build/07.png" alt="07"></p>
<p><img src="/../images/Cloud-Build/08.png" alt="08"></p>
<h4 id="推送版本到指定的-github-存放區，觸發-CloudBuild"><a href="#推送版本到指定的-github-存放區，觸發-CloudBuild" class="headerlink" title="推送版本到指定的 github 存放區，觸發 CloudBuild"></a>推送版本到指定的 github 存放區，觸發 CloudBuild</h4><p>紀錄 &gt; 版本紀錄可查看是哪條觸發名稱推送版本</p>
<h4 id="成功建置-image-到-GAR"><a href="#成功建置-image-到-GAR" class="headerlink" title="成功建置 image 到 GAR"></a>成功建置 image 到 GAR</h4><p>GAR &gt; 存放區 檢查image有成功推上去</p>
<hr>
<h2 id="Cloud-Deploy-1"><a href="#Cloud-Deploy-1" class="headerlink" title="Cloud Deploy"></a>Cloud Deploy</h2><p>將應用程式部署至GKE</p>
<h3 id="準備-skaffold-yaml、k8s-pod-yaml、clouddeploy-yaml"><a href="#準備-skaffold-yaml、k8s-pod-yaml、clouddeploy-yaml" class="headerlink" title="準備 skaffold.yaml、k8s-pod.yaml、clouddeploy.yaml"></a>準備 skaffold.yaml、k8s-pod.yaml、clouddeploy.yaml</h3><p>skaffold.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">skaffold/v4beta7</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">manifests:</span></span><br><span class="line">  <span class="attr">rawYaml:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">k8s-*</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">kubectl:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>k8s-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lily-clouddeploy-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">cloud.google.com/gke-nodepool:</span> <span class="string">lily1</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">my-app-image</span></span><br></pre></td></tr></table></figure>

<p>clouddeploy.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">deploy.cloud.google.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DeliveryPipeline</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lily-clouddeploy-test</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">main</span> <span class="string">application</span> <span class="string">pipeline</span></span><br><span class="line"><span class="attr">serialPipeline:</span></span><br><span class="line">  <span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targetId:</span> <span class="string">lily1</span></span><br><span class="line">    <span class="attr">profiles:</span> []</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">deploy.cloud.google.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Target</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lily1</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">development</span> <span class="string">cluster</span></span><br><span class="line"><span class="attr">gke:</span></span><br><span class="line">  <span class="attr">cluster:</span> <span class="string">projects/lab-0808/locations/asia-east1-a/clusters/lab-gke</span></span><br></pre></td></tr></table></figure>


<h3 id="使用-Cloud-Deploy-服務註冊管道與目標"><a href="#使用-Cloud-Deploy-服務註冊管道與目標" class="headerlink" title="使用 Cloud Deploy 服務註冊管道與目標"></a>使用 Cloud Deploy 服務註冊管道與目標</h3><p>指令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcloud deploy apply --file=clouddeploy.yaml --region=asia-east1 --project=lab-0808</span><br></pre></td></tr></table></figure>
<p>成功訊息<br><img src="/../images/Cloud-Build/09.png" alt="09"></p>
<h3 id="建立版本"><a href="#建立版本" class="headerlink" title="建立版本"></a>建立版本</h3><p>指令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gcloud deploy releases create release-lily1-2 \</span><br><span class="line">  --project=lab-0808 \</span><br><span class="line">  --region=asia-east1 \</span><br><span class="line">  --delivery-pipeline=lily-clouddeploy-test \</span><br><span class="line">  --images=my-app-image=gasia-east1-docker.pkg.dev/lab-0808/lily-test/quickstart-image:tag1</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="補充"><a href="#補充" class="headerlink" title="補充:"></a>補充:</h2><h3 id="Q1"><a href="#Q1" class="headerlink" title="Q1."></a>Q1.</h3><h4 id="h4觸發條件連接Google-Source-Repositories"><a href="#h4觸發條件連接Google-Source-Repositories" class="headerlink" title="h4觸發條件連接Google Source Repositories"></a>h4觸發條件連接Google Source Repositories</h4><p>A. 先在Source Repositories建立存放區，再建立觸發條件時，存放區版本第1代中可直接選擇Cloud Source Repositories，不用連結新的存放區</p>
<h3 id="Q2"><a href="#Q2" class="headerlink" title="Q2."></a>Q2.</h3><h4 id="Cloud-Build-自動帶版號"><a href="#Cloud-Build-自動帶版號" class="headerlink" title="Cloud Build 自動帶版號"></a>Cloud Build 自動帶版號</h4><p>A.<br>方法一、cloudbuild.yaml 使用環境變量 $SHORT_SHA’<br>使用 git 提交的前7個字符作為版本號</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">steps:</span><br><span class="line">- name: &#x27;gcr.io/cloud-builders/docker&#x27;</span><br><span class="line">  args: [</span><br><span class="line">    &#x27;build&#x27;,</span><br><span class="line">    &#x27;-t&#x27;,</span><br><span class="line">    &#x27;asia-east1-docker.pkg.dev/lab-0808/lily-test/quickstart-image:$SHORT_SHA&#x27;,</span><br><span class="line">    &#x27;.&#x27;,</span><br><span class="line">  ]</span><br><span class="line">images:</span><br><span class="line">  - &#x27;asia-east1-docker.pkg.dev/lab-0808/lily-test/quickstart-image:$SHORT_SHA&#x27;</span><br></pre></td></tr></table></figure>

<p>方法二、cloudbuild.yaml 使用環境變量 $BUILD_ID’<br>使用每次構建的唯一標示符來生成版號<br><img src="/../images/Cloud-Build/10.png" alt="10"></p>
<p>方法三、自動遞增版本號</p>
<h3 id="Q3"><a href="#Q3" class="headerlink" title="Q3."></a>Q3.</h3><h4 id="目標環境同一個-GKE-Cluster"><a href="#目標環境同一個-GKE-Cluster" class="headerlink" title="目標環境同一個 GKE Cluster"></a>目標環境同一個 GKE Cluster</h4><p>A.使用 skaffold.yaml 設定變數可以區分環境<br>( 待補充設定方式 )</p>
<hr>
<h3 id="參考文件"><a href="#參考文件" class="headerlink" title="參考文件"></a>參考文件</h3><p>Cloud Build<br><a href="https://cloud.google.com/build/docs/build-push-docker-image">https://cloud.google.com/build/docs/build-push-docker-image</a><br>Cloud Deploy<br><a href="https://cloud.google.com/deploy/docs/overview">https://cloud.google.com/deploy/docs/overview</a><br>build trigger<br><a href="https://cloud.google.com/build/docs/automating-builds/create-manage-triggers#build_trigger">https://cloud.google.com/build/docs/automating-builds/create-manage-triggers#build_trigger</a><br>Build and Deploy apps with CI&#x2F;CD<br><a href="https://cloud.google.com/build/docs">https://cloud.google.com/build/docs</a></p>
]]></content>
      <categories>
        <category>技術文件</category>
        <category>CI/CD</category>
      </categories>
      <tags>
        <tag>GCP</tag>
        <tag>CI/CD</tag>
      </tags>
  </entry>
  <entry>
    <title>Github_Page - 在 GitHub 建立個人部落格</title>
    <url>/2025/03/10/Github-Page/</url>
    <content><![CDATA[<h1 id="Step-1-建立新儲存庫"><a href="#Step-1-建立新儲存庫" class="headerlink" title="Step.1 建立新儲存庫"></a>Step.1 建立新儲存庫</h1><ul>
<li>儲存庫名稱命名為 <code>username.github.io</code> username 需為 Github 使用者名稱，後續才可以直接用此名稱開啟頁面 (下圖示範因已建立過相同檔名所以有紅字，正常要是綠色勾勾)</li>
<li>勾選 public 公開</li>
</ul>
<p><img src="/../images/Github-Page/Github-Page_01.png"></p>
<hr>
<h1 id="Step-2-在本地端安裝Hexo-wsl2"><a href="#Step-2-在本地端安裝Hexo-wsl2" class="headerlink" title="Step.2 在本地端安裝Hexo (wsl2)"></a>Step.2 在本地端安裝Hexo (wsl2)</h1><ul>
<li><p>安裝 npm &lt;<a href="https://github.com/nodejs-tw/nodejs-wiki-book/blob/master/zh-tw/node_npm.rst?source=post_page-----4d295ed96236---------------------------------------">NPM 套件管理工具</a>&gt;</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install python-software-properties</span><br><span class="line"><span class="built_in">sudo</span> add-apt-repository ppa:gias-kay-lee/npm</span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install npm</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>
</li>
<li><p>安裝 hexo (在vscode操作會比較方便)</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> npm install hexo-cli -g</span><br><span class="line">hexo init &lt;username&gt;.github.io <span class="comment">#跟剛剛建的倉庫同名字，會建出很多檔案</span></span><br><span class="line"><span class="built_in">cd</span> &lt;username&gt;.github.io</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
</li>
<li><p>推上 github 倉庫</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> &lt;username&gt;.github.io</span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m init</span><br><span class="line">git remote add origin git@github.com:&lt;your_repo&gt;/&lt;username&gt;.github.io.git</span><br><span class="line">git branch -M main</span><br><span class="line">git push -u origin main</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h1 id="Step-3-了解-Hexo-基本結構-操作指令"><a href="#Step-3-了解-Hexo-基本結構-操作指令" class="headerlink" title="Step.3 了解 Hexo 基本結構 &amp; 操作指令"></a>Step.3 了解 Hexo 基本結構 &amp; 操作指令</h1><ul>
<li><p>結構</p>
<blockquote>
<p>node_module -&gt; 這個專案所需要的Package (剛剛透過npm install所安裝)<br>  public -&gt; 存放網頁中的文章、圖片、標籤等資料。<br>  scaffolds -&gt; 存放網站的內容模板。<br>  themes -&gt; 存放網站的主題 (稍後介紹)<br>  _config.yml -&gt; 主要設定網站內容的檔案</p>
</blockquote>
</li>
<li><p>操作</p>
<blockquote>
<p>hexo clean  -&gt; 將目前資料夾中的所有靜態網頁清除<br>  hexo generate  -&gt; 按照當前設定檔，產生對應靜態網頁<br>  hexo server  -&gt; 在本地端產生網頁 localhost:4000<br>  hexo deploy  -&gt; 部署到 GitHub</p>
</blockquote>
</li>
</ul>
<hr>
<h1 id="Step-4-部署靜態頁面到分支"><a href="#Step-4-部署靜態頁面到分支" class="headerlink" title="Step.4 部署靜態頁面到分支"></a>Step.4 部署靜態頁面到分支</h1><ul>
<li><p>修改 <code>_config.yml</code> 中的 deploy 內容 ( 這邊指定新的分支 gh-pages，待會deploy時會在遠端自動建立 )</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">git@github.com:lilylinzz/lilylinzz.github.io.git</span></span><br><span class="line">  <span class="comment"># example, https://github.com/hexojs/hexojs.github.io</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">gh-pages</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>之後若有修改網頁內容，皆測試後部署到分支</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo generate</span><br><span class="line">hexo server     <span class="comment"># localhost:4000 本地測試，沒問題即可部署</span></span><br><span class="line">hexo deploy     <span class="comment">#只會將靜態網頁部署到分支</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>到 github_page 頁面選擇分支 → save</p>
</li>
</ul>
<p><img src="/../images/Github-Page/Github-Page_02.png" alt="image"></p>
<ul>
<li><p>https:&#x2F;&#x2F;<username>.github.io 即可看到自己的網站</p>
<hr>
<p>  其他</p>
<ul>
<li><p>_config.yml 調整標題、描述、作者…等等</p>
</li>
<li><p>也可另外選主題更換 (各別主題有安裝教學)<br>  <a href="https://hexo.io/themes/?source=post_page">https://hexo.io/themes/?source=post_page</a></p>
</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>個人網頁</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo-decorate</title>
    <url>/2025/03/12/hexo-decorate/</url>
    <content><![CDATA[<h2 id="圓角"><a href="#圓角" class="headerlink" title="圓角"></a>圓角</h2><p><code>~/source/_data/variables.styl</code> 此檔案中加入設定 (沒有檔案就自己新增)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// 圆角设置</span><br><span class="line"><span class="variable">$border</span>-radius-inner     = 15px; <span class="comment">#數字越大圓角弧度越大</span></span><br><span class="line"><span class="variable">$border</span>-radius           = 15px;</span><br><span class="line"></span><br><span class="line">//側邊欄位頂部黑色背景，設置上方圓角</span><br><span class="line">.site-brand-container&#123;</span><br><span class="line">    border-radius: 15px 15px 0px 0px; <span class="comment">#順序: 左上 右上 左下 右下</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="調整文章標題與內文之的寬度"><a href="#調整文章標題與內文之的寬度" class="headerlink" title="調整文章標題與內文之的寬度"></a>調整文章標題與內文之的寬度</h3><p>標題下的 margin-bottom 為 60px，導致在行動裝置上看起來間距太大，調整為 25px。</p>
<p><code>~/source/_data/variables.styl</code> 添加設定</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//調整文章標題與內文縮排</span><br><span class="line">.post-header.animated.fadeInDown &#123;</span><br><span class="line">  margin-bottom: 25px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>呈現<br><img src="/../images/hexo-decorate/01.png" alt="01"></p>
<hr>
]]></content>
      <categories>
        <category>個人網頁</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo_sidebar</title>
    <url>/2025/03/12/hexo-sidebar/</url>
    <content><![CDATA[<h2 id="加入頭像"><a href="#加入頭像" class="headerlink" title="加入頭像"></a>加入頭像</h2><p><code>~/_config.next.yml</code> 調整設定檔中 avatar url</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line">avatar:</span><br><span class="line">  url: /images/avatar.png</span><br><span class="line">  rounded: <span class="literal">true</span> <span class="comment">#改圓型</span></span><br><span class="line">  rotated: <span class="literal">false</span> <span class="comment">#旋轉</span></span><br></pre></td></tr></table></figure>

<p>在 <code>hexo_root/source/images/avatar.png</code> 設置自己的圖片</p>
<hr>
<h2 id="加入-social-link-Email-Linkedin"><a href="#加入-social-link-Email-Linkedin" class="headerlink" title="加入 social link - Email &amp; Linkedin"></a>加入 social link - Email &amp; Linkedin</h2><p><code>~/_config.next.yml</code>  設定檔中，Github、Email移除註解，Linkedin要自己新增</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">social:</span><br><span class="line">  GitHub: https://lilylinzz.github.io/ || fab fa-github</span><br><span class="line">  E-Mail: mailto:lingaadin@gmail.com || fa fa-envelope</span><br><span class="line">  Linkedin: https://www.linkedin.com/in/lilylin-94a835229 || fab fa-linkedin-in</span><br></pre></td></tr></table></figure>

<p>social_icons &gt; icons_only 改為true，只顯示icon</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">social_icons:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span> <span class="comment">#預設</span></span><br><span class="line">  icons_only: <span class="literal">true</span></span><br><span class="line">  transition: <span class="literal">false</span> <span class="comment">#預設</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="添加分類、標籤功能"><a href="#添加分類、標籤功能" class="headerlink" title="添加分類、標籤功能"></a>添加分類、標籤功能</h2><p><code>~/_config.next.yml</code> 設定檔中找到 menu 的設置，取消註解 tag、categories<br>(如果要添加”about_me”頁面，也是相同作法)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">menu:</span><br><span class="line">  home: / || fa fa-home</span><br><span class="line">  #about: /about/ || fa fa-user</span><br><span class="line">  tags: /tags/ || fa fa-tags</span><br><span class="line">  categories: /categories/ || fa fa-th</span><br><span class="line">  archives: /archives/ || fa fa-archive</span><br><span class="line">  #schedule: /schedule/ || fa fa-calendar</span><br><span class="line">  #sitemap: /sitemap.xml || fa fa-sitemap</span><br><span class="line">  #commonweal: /404/ || fa fa-heartbeat</span><br></pre></td></tr></table></figure>
<p>建立page，建立後會在 source 目錄下長出 tags、categories 資料夾，底下有 <a href="http://index.md/">index.md</a> 檔案</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo new page <span class="string">&quot;tags&quot;</span></span><br><span class="line">hexo new page <span class="string">&quot;categories&quot;</span></span><br></pre></td></tr></table></figure>

<p>編輯 <a href="http://index.md/">index.md</a> 加入對應的 type</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line"><span class="built_in">date</span>: 2025-03-10 17:53:58</span><br><span class="line"><span class="built_in">type</span>: tags</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line"><span class="built_in">date</span>: 2025-03-12 13:51:42</span><br><span class="line"><span class="built_in">type</span>: categories</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p>後續在每篇文章頂部，輸入標籤及分類格式如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">title: </span><br><span class="line">date: </span><br><span class="line">tags: </span><br><span class="line">      - tagA</span><br><span class="line">      - tagB</span><br><span class="line">categories: </span><br><span class="line">- [AA分類, aa子分類]</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="搜尋功能"><a href="#搜尋功能" class="headerlink" title="搜尋功能"></a>搜尋功能</h2><p>跟目錄安裝</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb</span><br></pre></td></tr></table></figure>

<p><code>~/_config.yml</code> Hexo設定檔加入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Search Service</span></span><br><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br><span class="line">  content: <span class="literal">true</span></span><br><span class="line">  format: html</span><br></pre></td></tr></table></figure>

<p><code>~/_config.next.yml</code> NexT設定檔 local_search &gt; enable 改為 true</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local_search:</span><br><span class="line">  enable: true</span><br><span class="line">  # Show top n results per article, show all results by setting to -1</span><br><span class="line">  top_n_per_article: 1</span><br><span class="line">  # Unescape html strings to the readable one.</span><br><span class="line">  unescape: false</span><br><span class="line">  # Preload the search data when the page loads.</span><br><span class="line">  preload: false</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>個人網頁</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheus/Grafana (GKE)</title>
    <url>/2025/03/11/Prometheus-Grafana-GKE/</url>
    <content><![CDATA[<h2 id="Prometheus-架構圖"><a href="#Prometheus-架構圖" class="headerlink" title="Prometheus 架構圖"></a>Prometheus 架構圖</h2><p><img src="https://i.imgur.com/ubC5Dxe.png"></p>
<p>來源: [yasongxu|container-monitor](<a href="https://github.com/yasongxu/container-monitor/blob/master/opensource/agent/prometheus/Prometheus%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84.md">https://github.com/yasongxu/container-monitor/blob/master/opensource/agent/prometheus/Prometheus%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84.md</a></p>
<hr>
<h2 id="建置Prometheus"><a href="#建置Prometheus" class="headerlink" title="建置Prometheus"></a>建置Prometheus</h2><h3 id="1-創建-ClusterRole-ServiceAccount"><a href="#1-創建-ClusterRole-ServiceAccount" class="headerlink" title="1.創建 ClusterRole + ServiceAccount"></a>1.創建 ClusterRole + ServiceAccount</h3><p><code>prometheus-rbac.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">  <span class="attr">verbs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">/metrics</span></span><br><span class="line">  <span class="attr">verbs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f prometheus-rbac.yaml</span><br></pre></td></tr></table></figure>

<h3 id="2-創建Prometheus-ConfigMap"><a href="#2-創建Prometheus-ConfigMap" class="headerlink" title="2.創建Prometheus ConfigMap"></a>2.創建Prometheus ConfigMap</h3><p><code>prometheus-conf.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-server-conf</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus-server-conf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 1m</span></span><br><span class="line"><span class="string">      scrape_timeout: 1m</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="attr">rule_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/prometheus/alert-rules-configmap.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">alerting:</span></span><br><span class="line">      <span class="attr">alertmanagers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9093&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">        <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;prometheus:9090&#x27;</span>]</span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node-exporter&#x27;</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;node-exporter:9100&#x27;</span>]</span><br><span class="line">          <span class="attr">labels:</span></span><br><span class="line">            <span class="attr">instance:</span> <span class="string">node</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kube-state-metrics&#x27;</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;kube-state-metrics:8080&#x27;</span>]</span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">kubernetes-pods</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">&quot;(.+)&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_node_name</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_node_name</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">kubernetes-cadvisor</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">        <span class="attr">metric_relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">instance</span>]</span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">node</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f prometheus-conf.yaml</span><br></pre></td></tr></table></figure>

<h3 id="3-創建Prometheus-的-Deployment、Service"><a href="#3-創建Prometheus-的-Deployment、Service" class="headerlink" title="3.創建Prometheus 的 Deployment、Service"></a>3.創建Prometheus 的 Deployment、Service</h3><p><code>prometheus.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">cloud.google.com/gke-nodepool:</span> <span class="string">lily-pool</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">prom/prometheus:v2.24.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.path=/prometheus/&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-server-conf</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;         </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">prometheus.io/port:</span>   <span class="string">&#x27;9090&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f prometheus.yaml</span><br></pre></td></tr></table></figure>

<h3 id="4-檢查透過-EXTERNAL-IP-9090-可查看Prometheus-Dashboard"><a href="#4-檢查透過-EXTERNAL-IP-9090-可查看Prometheus-Dashboard" class="headerlink" title="4.檢查透過 EXTERNAL-IP:9090 可查看Prometheus Dashboard"></a>4.檢查透過 EXTERNAL-IP:9090 可查看Prometheus Dashboard</h3><p><img src="https://i.imgur.com/26RhYf7.png"></p>
<hr>
<h2 id="加入-Kube-State-metrics"><a href="#加入-Kube-State-metrics" class="headerlink" title="加入 Kube State metrics"></a>加入 Kube State metrics</h2><p>Kube狀態指標-用以獲取有關如Deployment、pod、daemonsets、Statefulsets 等的資源指標。</p>
<h3 id="1-建立ClustorRole-ServiceAccount-metrics-rbac-yaml"><a href="#1-建立ClustorRole-ServiceAccount-metrics-rbac-yaml" class="headerlink" title="1.建立ClustorRole + ServiceAccount metrics-rbac.yaml"></a>1.建立ClustorRole + ServiceAccount <code>metrics-rbac.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">automountServiceAccountToken:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">2.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">lily</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">2.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">lily</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">lily</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">2.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">lily</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">serviceaccounts</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">resourcequotas</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">limitranges</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">persistentvolumes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cronjobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jobs</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">autoscaling</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tokenreviews</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authorization.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">subjectaccessreviews</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">certificates.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">certificatesigningrequests</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">discovery.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpointslices</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">storage.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">storageclasses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">volumeattachments</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">admissionregistration.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mutatingwebhookconfigurations</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">validatingwebhookconfigurations</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingressclasses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">coordination.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">clusterrolebindings</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">clusterroles</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rolebindings</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">roles</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f metrics-rbac.yaml</span><br></pre></td></tr></table></figure>
<h3 id="2-創建Metrics-State-metrics-的-Deployment、Service"><a href="#2-創建Metrics-State-metrics-的-Deployment、Service" class="headerlink" title="2.創建Metrics State metrics 的 Deployment、Service"></a>2.創建Metrics State metrics 的 Deployment、Service</h3><p><code>metrics.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">2.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/version:</span> <span class="number">2.7</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">cloud.google.com/gke-nodepool:</span> <span class="string">lily-pool</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">      <span class="attr">automountServiceAccountToken:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.7.0</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-metrics</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">telemetry</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">65534</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">2.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-metrics</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">telemetry</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">telemetry</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-state-metrics</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f metrics.yaml</span><br></pre></td></tr></table></figure>
<h3 id="3-檢查-prometheus-conf-yaml-中有加入這段"><a href="#3-檢查-prometheus-conf-yaml-中有加入這段" class="headerlink" title="3.檢查 prometheus-conf.yaml 中有加入這段"></a>3.檢查 prometheus-conf.yaml 中有加入這段</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- job_name: &#x27;kube-state-metrics&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;kube-state-metrics.kube-system.svc.cluster.local:8080&#x27;]</span><br></pre></td></tr></table></figure>
<h3 id="4-從Prometheus-UI確認狀態為up"><a href="#4-從Prometheus-UI確認狀態為up" class="headerlink" title="4.從Prometheus UI確認狀態為up"></a>4.從Prometheus UI確認狀態為up</h3><p><img src="https://i.imgur.com/LfEXhVG.png"></p>
<hr>
<h2 id="加入-Node-Exporter"><a href="#加入-Node-Exporter" class="headerlink" title="加入 Node Exporter"></a>加入 Node Exporter</h2><p>節點導出器-收集node機器本身相關資訊，包含cpu、記憶體、硬碟用量等，並透過metrics來獲取這些資訊</p>
<h3 id="1-建立-Daemonset、Service-在每個節點中運行-Node-Exporter"><a href="#1-建立-Daemonset、Service-在每個節點中運行-Node-Exporter" class="headerlink" title="1.建立 Daemonset、Service 在每個節點中運行 Node Exporter"></a>1.建立 Daemonset、Service 在每個節點中運行 Node Exporter</h3><p><code>node-exporter.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">cloud.google.com/gke-nodepool:</span> <span class="string">lily-pool</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--path.sysfs=/host/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--path.rootfs=/host/root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--no-collector.wifi</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--no-collector.hwmon</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collector.netclass.ignored-devices=^(veth.*)$</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">180Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">102m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">180Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host/sys</span></span><br><span class="line">          <span class="attr">mountPropagation:</span> <span class="string">HostToContainer</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host/root</span></span><br><span class="line">          <span class="attr">mountPropagation:</span> <span class="string">HostToContainer</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">prometheus.io/port:</span>   <span class="string">&#x27;9100&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/component:</span> <span class="string">exporter</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl appy -f node-exporter.yaml</span><br></pre></td></tr></table></figure>

<h3 id="2-檢查node-exporder服務的endpoint是否指向所有Node"><a href="#2-檢查node-exporder服務的endpoint是否指向所有Node" class="headerlink" title="2.檢查node-exporder服務的endpoint是否指向所有Node"></a>2.檢查node-exporder服務的endpoint是否指向所有Node</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get endpoints -n monitor</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/tqJOgei.png"></p>
<h3 id="3-檢查-prometheus-conf-yaml-中有加入這段-1"><a href="#3-檢查-prometheus-conf-yaml-中有加入這段-1" class="headerlink" title="3.檢查 prometheus-conf.yaml 中有加入這段"></a>3.檢查 prometheus-conf.yaml 中有加入這段</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- job_name: &#x27;node-exporter&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&#x27;node-exporter:9100&#x27;]</span><br><span class="line">    labels:</span><br><span class="line">      instance: node</span><br></pre></td></tr></table></figure>
<h3 id="4-從Prometheus-UI確認狀態為up-1"><a href="#4-從Prometheus-UI確認狀態為up-1" class="headerlink" title="4.從Prometheus UI確認狀態為up"></a>4.從Prometheus UI確認狀態為up</h3><p><img src="https://i.imgur.com/4P2GHkX.png"></p>
<hr>
<h2 id="設置-Grafana"><a href="#設置-Grafana" class="headerlink" title="設置 Grafana"></a>設置 Grafana</h2><h3 id="1-建立-Deployment、PVC、Service、datasource-configmap"><a href="#1-建立-Deployment、PVC、Service、datasource-configmap" class="headerlink" title="1.建立 Deployment、PVC、Service、datasource-configmap"></a>1.建立 Deployment、PVC、Service、datasource-configmap</h3><p><code>grafana.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">cloud.google.com/gke-nodepool:</span> <span class="string">lily-pool</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/grafana-enterprise:9.0.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">lily</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">lily</span></span><br><span class="line">        <span class="comment"># 更改UI路徑，預設為http://localhost:3000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SERVER_ROOT_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://34.80.42.154:3000</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-pvc</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-datasources</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/etc/grafana/provisioning/datasources</span></span><br><span class="line">            <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-pvc</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">grafana-pvc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-datasources</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">              <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">grafana-datasources</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">lily</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">prometheus.io/port:</span> <span class="string">&#x27;3000&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span> </span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-datasources</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yaml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;apiVersion&quot;: 1,</span></span><br><span class="line"><span class="string">        &quot;datasources&quot;: [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;access&quot;:&quot;proxy&quot;,</span></span><br><span class="line"><span class="string">                &quot;editable&quot;: true,</span></span><br><span class="line"><span class="string">                &quot;name&quot;: &quot;prometheus&quot;,</span></span><br><span class="line"><span class="string">                &quot;orgId&quot;: 1,</span></span><br><span class="line"><span class="string">                &quot;type&quot;: &quot;prometheus&quot;,</span></span><br><span class="line"><span class="string">                &quot;url&quot;: &quot;http://prometheus:9090&quot;,</span></span><br><span class="line"><span class="string">                &quot;version&quot;: 1</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl appy -f grafana.yaml</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="設置-Alertmanager"><a href="#設置-Alertmanager" class="headerlink" title="設置 Alertmanager"></a>設置 Alertmanager</h2><hr>
<h2 id="加入k8s集群外部監控"><a href="#加入k8s集群外部監控" class="headerlink" title="加入k8s集群外部監控"></a>加入k8s集群外部監控</h2><h3 id="LinuxVM"><a href="#LinuxVM" class="headerlink" title="LinuxVM"></a>LinuxVM</h3><h4 id="1-VM安裝prometheus-node-exporter"><a href="#1-VM安裝prometheus-node-exporter" class="headerlink" title="1.VM安裝prometheus-node-exporter"></a>1.VM安裝prometheus-node-exporter</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---安裝---</span><br><span class="line">apt update</span><br><span class="line">apt install prometheus-node-exporter</span><br><span class="line">---檢查---</span><br><span class="line">service prometheus-node-exporter status</span><br><span class="line">curl http://localhost:9100/metrics | grep &quot;node_&quot;</span><br></pre></td></tr></table></figure>

<h4 id="2-prometheus-conf增加job"><a href="#2-prometheus-conf增加job" class="headerlink" title="2.prometheus-conf增加job"></a>2.prometheus-conf增加job</h4><p>基於文件的動態服務發現 <code>file_sd_config</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;linuxvm&#x27;</span></span><br><span class="line">        <span class="attr">scrape_interval:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">file_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/etc/prometheus/externalvm.yml</span></span><br></pre></td></tr></table></figure>

<h4 id="3-新增configmap"><a href="#3-新增configmap" class="headerlink" title="3.新增configmap"></a>3.新增configmap</h4><p>targets可同時列出需要監控的多部主機<br><code>prometheus-externalvm.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-externalvm</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus-externalvm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">externalvm.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    - targets:</span></span><br><span class="line"><span class="string">      - &quot;ip:9100&quot;</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        instance: node</span></span><br></pre></td></tr></table></figure>

<h4 id="4-重新apply-prometheus-externalvm-yaml-、prometheus-yaml"><a href="#4-重新apply-prometheus-externalvm-yaml-、prometheus-yaml" class="headerlink" title="4.重新apply prometheus-externalvm.yaml 、prometheus.yaml"></a>4.重新apply prometheus-externalvm.yaml 、prometheus.yaml</h4><p>從Prometheus UI確認狀態為up<br><img src="https://hackmd.io/_uploads/HysgnKtYyg.png" alt="image"></p>
<hr>
<p>參考:<br><a href="https://devopscube.com/setup-prometheus-monitoring-on-kubernetes/">https://devopscube.com/setup-prometheus-monitoring-on-kubernetes/</a><br><a href="http://www.mydlq.club/article/113/">http://www.mydlq.club/article/113/</a></p>
]]></content>
      <categories>
        <category>技術文件</category>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>gke</tag>
        <tag>monitor</tag>
      </tags>
  </entry>
  <entry>
    <title>k3s cluster</title>
    <url>/2025/03/11/k3s-cluster/</url>
    <content><![CDATA[<h2 id="Multipass-建立虛擬機"><a href="#Multipass-建立虛擬機" class="headerlink" title="Multipass 建立虛擬機"></a>Multipass 建立虛擬機</h2><h3 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h3><p>由 Ubuntu Canonical推出的開源項目-輕量虛擬機管理器，Multipass 在 windows 上使用 Hyper-V，實現透過指令快速的建立、管理虛擬機器。</p>
<span id="more"></span>

<h3 id="下載"><a href="#下載" class="headerlink" title="下載"></a>下載</h3><p><a href="https://canonical.com/multipass">Multipass官網</a> 下載 windows 版 multipass</p>
<h3 id="網路設定"><a href="#網路設定" class="headerlink" title="網路設定"></a>網路設定</h3><p>1.於Hyper-V 右鍵建立 虛擬交換器管理員 -&gt;  外部 -&gt; 建立虛擬交換器 -&gt; 名稱(k3s)<br><img src="/../images/k3s-cluster/01.png" alt="01"></p>
<p>2.控制台 -&gt; 網路和共用中心 -&gt; 變更介面卡設定 -&gt; 乙太網路右鍵內容 -&gt; 開啟共用<br><img src="/../images/k3s-cluster/02.png" alt="02"></p>
<p>3.設定 bridge</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">multipass set local.bridged-network=k3s</span><br></pre></td></tr></table></figure>

<h3 id="建立虛擬機器"><a href="#建立虛擬機器" class="headerlink" title="建立虛擬機器"></a>建立虛擬機器</h3><p>1.建立3台虛擬機，做為 k3s node</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">multipass launch --name master --cpus 2 --memory 2g --disk 10g --bridged --network &quot;name=k3s,mode=manual&quot;</span><br><span class="line">multipass launch --name node1 --cpus 2 --memory 2g --disk 10g --bridged --network &quot;name=k3s,mode=manual&quot;</span><br><span class="line">multipass launch --name node2 --cpus 2 --memory 2g --disk 10g --bridged --network &quot;name=k3s,mode=manual&quot;</span><br></pre></td></tr></table></figure>

<p>2.設定自訂IP</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">multipass exec &#x27;master&#x27; -- sudo vi /etc/netplan/50-cloud-init.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eth2:</span><br><span class="line">    dhcp4: no</span><br><span class="line">    addresses: [192.168.137.33/24]</span><br><span class="line">    nameservers:</span><br><span class="line">      addresses: [8.8.8.8]</span><br><span class="line">    routes:</span><br><span class="line">      - to: 0.0.0.0</span><br><span class="line">        via: 192.168.137.1</span><br></pre></td></tr></table></figure>
<p>註: 192.168.137.1 如要更換掉預設值需修改註冊檔<br><img src="/../images/k3s-cluster/03.png" alt="03"></p>
<p>3.重啟master</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">multipass exec master -- sudo init 6</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="安裝-k3s"><a href="#安裝-k3s" class="headerlink" title="安裝 k3s"></a>安裝 k3s</h2><h3 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h3><p>1.登入 master 並安裝 k3s</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">multipass shell master</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export INSTALL_K3S_VERSION=v1.24.17+k3s1 &amp;&amp; curl -sfL &lt;https://get.k3s.io&gt; | K3S_KUBECONFIG_MODE=&quot;644&quot; INSTALL_K3S_EXEC=&quot; --disable traefik&quot; sh -</span><br></pre></td></tr></table></figure>

<p>2.查看master節點token與IP-複製起來備用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo cat /var/lib/rancher/k3s/server/node-token</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get node -owide</span><br></pre></td></tr></table></figure>

<h3 id="Worker-Nodes"><a href="#Worker-Nodes" class="headerlink" title="Worker Nodes"></a>Worker Nodes</h3><p>1.登入 node1 安裝 k3s，並加入master</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">multipass shell node1</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export INSTALL_K3S_VERSION=v1.24.17+k3s1 &amp;&amp; curl -sfL &lt;https://get.k3s.io&gt; | K3S_URL=https://192.168.137.33:6443 K3S_TOKEN=[剛剛查的master token] sh -</span><br></pre></td></tr></table></figure>
<p>2.登入 node2，重複上一步驟</p>
<p>3.回到 master 查看叢集狀態</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>

<p>4.node1 與 node2 新增 label node</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl label node node1 node-role.kubernetes.io/node=&quot;&quot;</span><br><span class="line">kubectl label node node2 node-role.kubernetes.io/node=&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>註: 刪除 label</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl label node node1 node-role.kubernetes.io/node-</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技術文件</category>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k3s</tag>
      </tags>
  </entry>
</search>
